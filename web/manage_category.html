<!DOCTYPE html>
<html>
<head>
    <title>GSMS - Manage Categories</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,300,600,700">

    <!-- Bootstrap + Custom Styles -->
    <link rel="stylesheet" href="web/static/bootstrap.min.css">
    <link rel="stylesheet" href="web/static/style.css">
    <link rel="stylesheet" href="web/static/sidebar-menu.css">
    <link rel="stylesheet" href="web/static/custom.css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">

    <style>
        /* Minimalistic Blue Theme */
         :root {
             --primary-blue: #4A90E2;
             --light-blue: #E6F0FA;
             --dark-blue: #2E5A87;
             --text-color: #333;
         }

         body {
             background: #F9FAFB;
             font-family: 'Roboto', sans-serif;
             color: var(--text-color);
         }

        .logout-btn-fixed {
             position: absolute;
             bottom: 0;
             width: 100%;
             background: none;
             color: var(--primary-blue);
             border: none;
             padding: 15px;
             text-align: center;
             font-weight: 500;
             transition: background 0.3s ease;
         }
         .logout-btn-fixed:hover {
             background: var(--light-blue);
         }

        /* Always visible sidebar on desktop */
        @media (min-width: 992px) {
            #mySidebar {
                display: block !important;
                width: 200px;
                position: fixed;
                height: 100%;
                z-index: 1000;
                background: white;
                border-right: 1px solid #E5E7EB;
            }
            #main {
                margin-left: 200px;
            }
            #openNav {
                display: none !important;
            }
        }

        /* Content margin reset on small screens */
        @media (max-width: 991px) {
            #main {
                margin-left: 0;
            }
        }
        /* Sidebar Styling */
         #mySidebar .w3-bar-item {
             color: var(--text-color);
             padding: 12px 16px;
             font-weight: 400;
             transition: background 0.3s ease, color 0.3s ease;
         }
         #mySidebar .w3-bar-item:hover {
             background: var(--light-blue);
             color: var(--primary-blue);
         }

        /* Стилі для повідомлень про помилки */
        .error-container {
            position: relative;
            min-height: 20px;
        }

        .error-message {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: flex-start;
            z-index: 1000;
            max-width: 100%;
        }

        .error-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background-color: #ff8c00;
            color: white;
            text-align: center;
            line-height: 16px;
            border-radius: 3px;
            font-size: 12px;
            margin-right: 5px;
            flex-shrink: 0;
        }

        .error-text {
            display: inline-block;
            background-color: white;
            color: #333;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 12px;
            white-space: normal;
            word-wrap: break-word;
            max-width: calc(100% - 25px);
        }

        .form-group .error-message {
            max-width: 100%;
        }

        /* Стилі для підсвічування червоним */
        .is-invalid {
            border: 2px solid #dc3545 !important;
            background-color: rgba(220, 53, 69, 0.05) !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
         /* Main Content Styling */
         h2 {
             color: var(--dark-blue);
             font-weight: 500;
             font-size: 24px;
             margin-bottom: 20px;
         }

         .table {
             border: 1px solid #E5E7EB;
             border-radius: 5px;
             overflow: hidden;
         }

         .table th, .table td {
             border: 1px solid #E5E7EB;
         }

         .form-control {
             border: 1px solid #E5E7EB;
             border-radius: 5px;
         }

         button {
             background: var(--primary-blue);
             color: white;
             border: none;
             padding: 8px 16px;
             border-radius: 5px;
             margin: 5px 0;
             cursor: pointer;
             font-weight: 500;
             transition: background 0.3s ease;
         }
         button:hover {
             background: var(--dark-blue);
         }

         .btn-secondary {
             background: #6c757d;
         }
         .btn-secondary:hover {
             background: #5a6268;
         }

         /* Modal Styling */
         .modal-content {
             border-radius: 8px;
             border: 1px solid #E5E7EB;
         }

         .modal-header h4 {
             color: var(--dark-blue);
             font-weight: 500;
         }

         .modal-footer button {
             background: var(--primary-blue);
             color: white;
             border: none;
             padding: 8px 16px;
             border-radius: 5px;
             transition: background 0.3s ease;
         }
         .modal-footer button:hover {
             background: var(--dark-blue);
         }

         .modal-footer .btn-secondary {
             background: #6c757d;
         }
         .modal-footer .btn-secondary:hover {
             background: #5a6268;
         }
    </style>
</head>
<body class="tooltips">

<!-- Sidebar -->
<div id="mySidebar" class="w3-sidebar w3-bar-block w3-card w3-animate-left w3-light-grey" style="display: none;">
    <button class="w3-bar-item w3-button w3-large w3-hide-large" onclick="w3_close()">✕ Close</button>
    <a href="/manage-employee" class="w3-bar-item w3-button role-manager">Workers</a>
    <a href="/manage_product" class="w3-bar-item w3-button role-manager role-cashier">Manage Products</a>
    <a href="/manage_store_product" class="w3-bar-item w3-button role-manager role-cashier">Store Products</a>
    <a href="/manage_category" class="w3-bar-item w3-button role-manager">Categories</a>
    <a href="/manage_customer" class="w3-bar-item w3-button role-manager role-cashier">Customers</a>
    <a href="/manage_check" class="w3-bar-item w3-button role-manager role-cashier">Checks</a>
    <a href="/reports" class="w3-bar-item w3-button role-manager">Reports</a>
    <a href="/manager_account.html" class="w3-bar-item w3-button role-manager">My Account</a>
    <a href="/cashier_account.html" class="w3-bar-item w3-button role-cashier">My Account</a>
    <a href="/logout" class="w3-bar-item w3-button logout-btn-fixed">Log Out</a>
</div>

<!-- Main -->
<div id="main">
    <!-- Header -->
    <div class="header content rows-content-header">
        <button id="openNav" class="w3-button w3-teal w3-xlarge">☰</button>
        <div class="navbar navbar-default" role="navigation">
            <div class="container">
                <div class="navbar-collapse collapse">
                    <ul class="nav navbar-nav visible-lg visible-md limit-chars">
                        <ul class="breadcrumb">
                            <a href="index.html">
                                <i class="zmdi zmdi-view-dashboard zmdi-hc-fw" title="Orders"></i>
                            </a>
                            <a href="manage-product.html">
                                <i class="zmdi zmdi-assignment zmdi-hc-fw" title="Products"></i>
                            </a>
                            <a href="manage_category">
                                <i class="zmdi zmdi-folder zmdi-hc-fw" title="Categories"></i>
                            </a>
                        </ul>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="right content-page">
            <div class="body content rows scroll-y">
                <div class="box-info full" id="taskFormContainer">
                    <h2>Manage Categories</h2>
                    <div class="panel-body pt-0">
                        <div class="row mb-4">
                            <div class="col-sm-12">
                                <button type="button" class="btn btn-sm btn-primary pull-right" id="addCategoryBtn">
                                    Add New Category
                                </button>
                                <button id="sortCategoriesBtn" class="btn btn-secondary ml-2">Sort by Name ▼</button>
                                <button id="sortBySalesBtn" class="btn btn-secondary ml-2">Sort by Sales ▼</button>
                                <button id="clearFiltersBtn" class="btn btn-secondary ml-2">Clear Filters</button>
                                <button id="deadCategoriesBtn" class="btn btn-sm btn-warning">Dead Categories</button>
                            </div>
                        </div>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Category Number</th>
                                    <th>Category Name</th>
                                    <th>Sales Count</th>
                                    <th style="width: 150px">Action</th>
                                </tr>
                            </thead>
                            <tbody id="categoryTableBody">
                                <!-- Category rows go here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade-scale" id="categoryModal" role="dialog" data-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Add New Category</h4>
                </div>
                <div class="modal-body">
                    <form id="categoryForm">
                        <input type="hidden" name="category_number" id="category_number">
                        <div class="form-group">
                            <label>Category Name</label>
                            <input class="form-control" name="category_name" id="category_name" type="text" placeholder="Category Name" required>
                            <div class="error-container">
                                <div id="category_name_error" class="error-message" style="display: none;">
                                    <span class="error-icon">⚠️</span>
                                    <span class="error-text"></span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveCategory">Save</button>
                </div>
            </div>
        </div>
    </div>

</div> <!-- #main -->

<!-- Modal for category summary -->
    <div class="modal fade" id="summaryModal" tabindex="-1" aria-labelledby="summaryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="summaryModalLabel">Зведення для категорії</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="summaryContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
                </div>
            </div>
        </div>
    </div>

<!-- Modal for dead categories -->
    <div class="modal fade" id="deadCategoriesModal" tabindex="-1" aria-labelledby="deadCategoriesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deadCategoriesModalLabel">Категорії без неактивних продуктів</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="deadCategoriesContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрити</button>
                </div>
            </div>
        </div>
    </div>

<!-- Scripts -->
<script src="web/js/package/jquery.min.js"></script>
<script src="web/js/package/bootstrap.min.js"></script>
<script src="web/js/common.js"></script>
<script src="web/js/manage-category.js"></script>

<script>
 // API endpoints
 var categoryListApiUrl = 'http://127.0.0.1:5000/getCategories';
 var categorySaveApiUrl = 'http://127.0.0.1:5000/saveCategory';
 var categoryDeleteApiUrl = 'http://127.0.0.1:5000/deleteCategory';

//для запиту
var storeProductsSummaryApiUrl = 'http://127.0.0.1:5000/api/reports/store-products-summary-by-category';
var summaryModal = $("#summaryModal");

 // DOM elements
 var categoryModal = $("#categoryModal");
 var categoryForm = $("#categoryForm");
 var sortDirection = 'asc'; // Default sort direction

 // Додайте цей код у ваш JavaScript-файл
 function clearPageData() {
     // Очистити всі відображувані дані
     document.getElementById('categoryTableBody').innerHTML = '';
     // Скинути всі форми
     document.querySelectorAll('form').forEach(form => form.reset());
     // Reset sort direction and button text
     sortDirection = 'asc';
     $("#sortCategoriesBtn").text('Sort by Name ▼');
     $("#sortBySalesBtn").text('Sort by Sales ▼');
     // Reload categories
     loadCategories();
 }

 // Викликайте цю функцію при переході між вкладками
 document.querySelectorAll('.tab-link').forEach(link => {
     link.addEventListener('click', clearPageData);
 });

 $(document).ready(function() {
     // Прибирати помилки при введенні в поля
     $('#category_name').on('input change', function() {
         const field = $(this).attr('id');
         $(`#${field}`).removeClass('is-invalid');
         $(`#${field}_error`).hide();
     });
     // Load categories when page loads
     loadCategories();

     // Setup event handlers
     $("#addCategoryBtn").click(openAddCategoryModal);
     $("#saveCategory").click(saveCategory);
     $("#sortCategoriesBtn").click(sortCategories);
     $("#sortBySalesBtn").click(sortBySales);
     $("#clearFiltersBtn").click(clearPageData);

     // Event delegation for dynamic buttons
     $(document).on('click', '.edit-category', editCategory);
     $(document).on('click', '.delete-category', deleteCategory);
     $(document).on('click', '.summary-category', showCategorySummary);


     // Reset form and clear errors when modal is closed
     categoryModal.on('hide.bs.modal', resetCategoryForm);

     // Clear errors when modal is opened
     categoryModal.on('show.bs.modal', function() {
         $('.error-message').hide().find('.error-text').text('');
         $('.is-invalid').removeClass('is-invalid');
     });
 });

 // Load all categories into the table with sales data
 function loadCategories() {
     $.get("/api/category_sales_count", function(salesData) {
         if (!Array.isArray(salesData)) {
             console.error("Invalid sales data format");
             alert("Error loading sales data.");
             return;
         }

         const salesMap = {};
         salesData.forEach(row => {
             salesMap[row.category_number] = row.total_sales;
         });

         $.get(categoryListApiUrl, function(categories) {
             displayCategories(categories, salesMap);
         }).fail(function(error) {
             console.error("Error loading categories:", error);
             alert("Error loading categories. Please check the console for details.");
         });
     }).fail(function(err) {
         console.error("Failed to load category sales count", err.responseText);
         alert("Failed to load sales data");
     });
 }

 // Display categories in the table
 function displayCategories(categories, salesMap = {}) {
     var tbody = $("#categoryTableBody");
     tbody.empty();

     categories.forEach(function(category) {
         const totalSales = salesMap[category.category_number] || 0;
         var row = `
             <tr data-number="${category.category_number}" data-name="${category.name}">
                 <td>${category.category_number}</td>
                 <td>${category.name}</td>
                 <td>${totalSales}</td>
                 <td>
                     <span class="btn btn-xs btn-primary edit-category">Edit</span>
                     <span class="btn btn-xs btn-danger delete-category">Delete</span>
                     <span class="btn btn-xs btn-info summary-category">Summary</span>
                 </td>
             </tr>
         `;
         tbody.append(row);
     });
 }

 // Sort categories by name
 function sortCategories() {
     $.get("/api/category_sales_count", function(salesData) {
         if (!Array.isArray(salesData)) {
             alert("Error loading sales data.");
             return;
         }

         const salesMap = {};
         salesData.forEach(row => {
             salesMap[row.category_number] = row.total_sales;
         });

         $.get(categoryListApiUrl, function(categories) {
             categories.sort(function(a, b) {
                 if (sortDirection === 'asc') {
                     return a.name.localeCompare(b.name);
                 } else {
                     return b.name.localeCompare(a.name);
                 }
             });

             sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
             $("#sortCategoriesBtn").text(sortDirection === 'asc' ? 'Sort by Name ▼' : 'Sort by Name ▲');
             displayCategories(categories, salesMap);
         }).fail(function(error) {
             console.error("Error loading categories for sorting:", error);
             alert("Error loading categories for sorting. Please check the console for details.");
         });
     }).fail(function(err) {
         console.error("Failed to load category sales count", err.responseText);
         alert("Failed to load sales data");
     });
 }

 // Sort categories by sales
 function sortBySales() {
     $.get("/api/category_sales_count", function(salesData) {
         if (!Array.isArray(salesData)) {
             alert("Error loading sales data.");
             return;
         }

         const salesMap = {};
         salesData.forEach(row => {
             salesMap[row.category_number] = row.total_sales;
         });

         $.get(categoryListApiUrl, function(categories) {
             categories.sort(function(a, b) {
                 const salesA = salesMap[a.category_number] || 0;
                 const salesB = salesMap[b.category_number] || 0;
                 return salesB - salesA;
             });

             displayCategories(categories, salesMap);
         });
     }).fail(function(err) {
         console.error("Failed to load category sales count", err.responseText);
         alert("Failed to load sales data");
     });
 }

 // Open modal for adding a new category
 function openAddCategoryModal() {
     resetCategoryForm();
     categoryModal.find('.modal-title').text('Add New Category');
     categoryModal.modal('show');
 }

 // Edit category - populate form with existing data
 function editCategory() {
     var tr = $(this).closest('tr');
     var categoryNumber = tr.data('number');
     var categoryName = tr.data('name');

     $("#category_number").val(categoryNumber);
     $("#category_name").val(categoryName);

     categoryModal.find('.modal-title').text('Edit Category');
     categoryModal.modal('show');
 }

 // Validate category form
 function validateCategoryForm() {
     let isValid = true;
     const errors = {};

     $('.error-message').hide().find('.error-text').text('');
     $('.is-invalid').removeClass('is-invalid');

     const categoryName = $("#category_name").val().trim();
     if (!categoryName) {
         errors.category_name = 'Назва категорії є обов\'язковим полем.';
         isValid = false;
     } else if (categoryName.length < 3) {
         errors.category_name = 'Назва категорії має містити щонайменше 3 символи.';
         isValid = false;
     } else if (!/^[a-zA-Z0-9\s]+$/.test(categoryName)) {
         errors.category_name = 'Назва категорії може містити лише літери, цифри та пробіли.';
         isValid = false;
     }

     for (let field in errors) {
         $(`#${field}_error`).find('.error-text').text(errors[field]);
         $(`#${field}_error`).show();
         $(`#${field}`).addClass('is-invalid');
     }

     return isValid;
 }

 // Save category (create or update)
 function saveCategory() {
     if (!validateCategoryForm()) {
         return;
     }

     var categoryData = {
         category_number: $("#category_number").val(),
         category_name: $("#category_name").val()
     };

     $.ajax({
         url: categorySaveApiUrl,
         method: 'POST',
         contentType: 'application/json',
         data: JSON.stringify(categoryData),
         success: function(response) {
             categoryModal.modal('hide');
             loadCategories();

             if (categoryData.category_number) {
                 alert("Category updated successfully");
             } else {
                 alert("Category created successfully");
             }
         },
         error: function(xhr, status, error) {
             console.error("Error saving category:", xhr.responseText);
             alert("Error saving category: " + xhr.responseText);
         }
     });
 }

 // Delete category
 function deleteCategory() {
     var tr = $(this).closest('tr');
     var categoryNumber = tr.data('number');
     var categoryName = tr.data('name');

     var confirmDelete = confirm(`Are you sure you want to delete the category "${categoryName}"?`);
     if (!confirmDelete) return;

     $.ajax({
         url: categoryDeleteApiUrl,
         method: 'POST',
         data: { category_number: categoryNumber },
         success: function(response) {
             if (response.success) {
                 alert("Category deleted successfully");
                 loadCategories();
             } else {
                 alert(response.message);
             }
         },
         error: function(xhr, status, error) {
             console.error("Error deleting category:", xhr.responseText);
             alert("Error deleting category: " + xhr.responseText);
         }
     });
 }

 // Reset category form and clear errors
 function resetCategoryForm() {
     categoryForm[0].reset();
     $("#category_number").val('');
     categoryModal.find('.modal-title').text('Add New Category');
     $('.error-message').hide().find('.error-text').text('');
     $('.is-invalid').removeClass('is-invalid');
 }
 </script>

<script>
    fetch('/api/employee_info', {
        method: 'GET',
        credentials: 'include'
    })
    .then(res => {
        if (!res.ok) {
            if (res.status === 401) window.location.href = '/login.html';
            throw new Error('Not authorized');
        }
        return res.json();
    })
    .then(data => {
        const role = data.empl_role.toLowerCase();

        // Сховати всі вкладки спочатку
        document.querySelectorAll('.role-manager, .role-cashier')
            .forEach(el => el.style.display = 'none');

        // Показати лише ті, що відповідають ролі
        document.querySelectorAll(`.role-${role}`)
            .forEach(el => el.style.display = 'block');

        // Показати сам сайдбар
        document.getElementById('mySidebar').style.display = 'block';
    })
    .catch(err => {
        console.error('Role fetch error:', err);
    });

    function w3_open() {
        document.getElementById('mySidebar').style.display = 'block';
        document.getElementById('main').style.marginLeft = '250px';
        document.getElementById('openNav').style.display = 'none';
    }

    function w3_close() {
        document.getElementById('mySidebar').style.display = 'none';
        document.getElementById('main').style.marginLeft = '0';
        document.getElementById('openNav').style.display = 'inline-block';
    }
</script>
<script>
    // Підсвічує активну вкладку сайдбару
    document.addEventListener('DOMContentLoaded', function () {
        const currentPath = window.location.pathname;
        const sidebarLinks = document.querySelectorAll('#mySidebar a');

        sidebarLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('w3-blue');
            }
        });
    });
</script>

<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9397807ffeecafa4',t:'MTc0NjE4ODczMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
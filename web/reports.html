<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>ZLAGODA ‚Äî –ó–≤—ñ—Ç–∏</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:400,300,600,700">

  <!-- Bootstrap + Custom Styles -->
  <link rel="stylesheet" href="web/static/bootstrap.min.css">
  <link rel="stylesheet" href="web/static/style.css">
  <link rel="stylesheet" href="web/static/sidebar-menu.css">
  <link rel="stylesheet" href="web/static/custom.css">
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">

  <style>
    .logout-btn-fixed {
      position: absolute;
      bottom: 0;
      width: 100%;
    }
    /* Always visible sidebar on desktop */
    @media (min-width: 992px) {
      #mySidebar {
        display: block !important;
        width: 200px;
        position: fixed;
        height: 100%;
        z-index: 1000;
      }
      #main {
        margin-left: 250px;
      }
      #openNav {
        display: none !important;
      }
    }

    /* Content margin reset on small screens */
    @media (max-width: 991px) {
      #main {
        margin-left: 0;
      }
    }

    /* Table styles */
    #report-output {
      width: 100%;
      max-width: 100%;
      overflow-x: auto; /* –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ */
      box-sizing: border-box; /* –í–∫–ª—é—á–∞—î–º–æ padding —ñ border —É —à–∏—Ä–∏–Ω—É */
      padding: 0 10px; /* –î–æ–¥–∞—î–º–æ –Ω–µ–≤–µ–ª–∏–∫–∏–π –≤—ñ–¥—Å—Ç—É–ø */
    }
    table {
      width: 100%;
      max-width: 100%; /* –£–Ω–∏–∫–∞—î–º–æ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–Ω—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      table-layout: fixed; /* –§—ñ–∫—Å–æ–≤–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ */
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #999;
      padding: 8px;
      text-align: left;
      white-space: normal;
      word-wrap: break-word;
      box-sizing: border-box;
      min-width: 100px; /* –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ */
      max-width: 250px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ */
      overflow: hidden; /* –û–±—Ä—ñ–∑–∞—î–º–æ –Ω–∞–¥–ª–∏—à–∫–æ–≤–∏–π –≤–º—ñ—Å—Ç */
      text-overflow: ellipsis; /* –î–æ–¥–∞—î–º–æ —Ç—Ä–∏ –∫—Ä–∞–ø–∫–∏ –¥–ª—è –¥–æ–≤–≥–æ–≥–æ —Ç–µ–∫—Å—Ç—É */
    }
    th {
      background-color: #eee;
      font-weight: bold;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è –º–∞–ª–∏—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
    @media (max-width: 768px) {
      th, td {
        min-width: 80px; /* –ó–º–µ–Ω—à—É—î–º–æ —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫ */
        max-width: 150px;
        font-size: 14px; /* –ó–º–µ–Ω—à—É—î–º–æ —à—Ä–∏—Ñ—Ç */
      }
    }

    /* Print styles */
    @media print {
      button, .no-print, .w3-sidebar {
        display: none !important;
      }
      #main {
        margin: 0 !important;
      }
      #report-output {
        overflow: visible;
        padding: 0;
      }
      table {
        width: 100%;
        max-width: 100%;
        table-layout: auto; /* –î–æ–∑–≤–æ–ª—è—î–º–æ —Ç–∞–±–ª–∏—Ü—ñ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏—Å—è */
      }
      th, td {
        font-size: 10px; /* –©–µ –º–µ–Ω—à–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –¥—Ä—É–∫—É */
        min-width: 50px;
        max-width: none; /* –ó–Ω—ñ–º–∞—î–º–æ –æ–±–º–µ–∂–µ–Ω–Ω—è */
        overflow: visible;
        text-overflow: clip;
      }
    }
  </style>
</head>
<body class="tooltips">

<!-- Sidebar -->
<div id="mySidebar" class="w3-sidebar w3-bar-block w3-card w3-animate-left w3-light-grey" style="display: none;">
  <button class="w3-bar-item w3-button w3-large w3-hide-large" onclick="w3_close()">‚úï Close</button>
  <a href="/manage-employee" class="w3-bar-item w3-button role-manager">Workers</a>
  <a href="/manage_product" class="w3-bar-item w3-button role-manager role-cashier">Manage Products</a>
  <a href="/manage_store_product" class="w3-bar-item w3-button role-manager role-cashier">Store Products</a>
  <a href="/manage_category" class="w3-bar-item w3-button role-manager">Categories</a>
  <a href="/manage_customer" class="w3-bar-item w3-button role-manager role-cashier">Customers</a>
  <a href="/manage_check" class="w3-bar-item w3-button role-manager role-cashier">Checks</a>
  <a href="/reports" class="w3-bar-item w3-button role-manager">Reports</a>
  <a href="/manager_account.html" class="w3-bar-item w3-button role-manager">My Account</a>
  <a href="/cashier_account.html" class="w3-bar-item w3-button role-cashier">My Account</a>
  <a href="/logout" class="w3-bar-item w3-button logout-btn-fixed">Log Out</a>
</div>

<!-- Main Content -->
<div id="main">
  <div class="header content rows-content-header">
    <button id="openNav" class="w3-button w3-teal w3-xlarge">‚ò∞</button>
    <div class="navbar navbar-default" role="navigation">
      <div class="container">
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav visible-lg visible-md limit-chars">
            <ul class="breadcrumb">
              <a href="index.html">
                <i class="zmdi zmdi-view-dashboard zmdi-hc-fw" title="Orders"></i>
              </a>
              <a href="reports.html">
                <i class="zmdi zmdi-assignment zmdi-hc-fw" title="Reports"></i>
              </a>
            </ul>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="right content-page">
      <div class="body content rows scroll-y">
        <div class="box-info full">
          <h2 class="no-print">–ó–≤—ñ—Ç–∏</h2>

          <!-- Buttons -->
          <div class="no-print">
            <button onclick="loadReport('employees')" class="btn btn-default">üßç –ü—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∏</button>
            <button onclick="loadReport('customers')" class="btn btn-default">ü™™ –ö–ª—ñ—î–Ω—Ç–∏</button>
            <button onclick="loadReport('categories')" class="btn btn-default">üóÇÔ∏è –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó</button>
            <button onclick="loadReport('products')" class="btn btn-default">üì¶ –¢–æ–≤–∞—Ä–∏</button>
            <button onclick="loadReport('store-products')" class="btn btn-default">üõí –¢–æ–≤–∞—Ä–∏ —É –º–∞–≥–∞–∑–∏–Ω—ñ</button>
            <button onclick="loadReport('receipts')" class="btn btn-default">üßæ –ß–µ–∫–∏</button>
            <button onclick="printReport()" class="btn btn-primary">üñ®Ô∏è –î—Ä—É–∫ –∑–≤—ñ—Ç—É</button>
          </div>

          <!-- Report Title -->
          <h3 id="report-title" class="mt-4"></h3>

          <!-- Output -->
          <div id="report-output" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="js/package/jquery.min.js"></script>
<script src="js/package/bootstrap.min.js"></script>

<script>
  fetch('/api/employee_info', {
    method: 'GET',
    credentials: 'include'
  })
  .then(res => {
    if (!res.ok) {
      if (res.status === 401) window.location.href = '/login.html';
      throw new Error('Not authorized');
    }
    return res.json();
  })
  .then(data => {
    const role = data.empl_role.toLowerCase().replace(/cashier/i, 'cashier').replace(/manager/i, 'manager');
    console.log("User role:", role); // –î–µ–±–∞–≥

    // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –∑ –∫–ª–∞—Å–∞–º–∏ role-manager —ñ role-cashier
    document.querySelectorAll('.role-manager, .role-cashier')
        .forEach(el => el.style.display = 'none');

    // –ü–æ–∫–∞–∑—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ä–æ–ª—ñ
    document.querySelectorAll(`.role-${role}`)
        .forEach(el => el.style.display = 'block');

    // –ü–æ–∫–∞–∑—É—î–º–æ –±—ñ—á–Ω—É –ø–∞–Ω–µ–ª—å
    document.getElementById('mySidebar').style.display = 'block';
  })
  .catch(err => {
    console.error('Role fetch error:', err);
  });

  function w3_open() {
    document.getElementById('mySidebar').style.display = 'block';
    document.getElementById('main').style.marginLeft = '250px';
    document.getElementById('openNav').style.display = 'none';
  }

  function w3_close() {
    document.getElementById('mySidebar').style.display = 'none';
    document.getElementById('main').style.marginLeft = '0';
    document.getElementById('openNav').style.display = 'inline-block';
  }

  function loadReport(type) {
    const endpoints = {
      'employees': '/api/reports/employees',
      'customers': '/api/reports/customers',
      'categories': '/api/reports/categories',
      'products': '/api/reports/products',
      'store-products': '/api/reports/store-products',
      'receipts': '/api/reports/receipts',
    };

    const titles = {
      'employees': '–ó–≤—ñ—Ç –ø–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞—Ö',
      'customers': '–ó–≤—ñ—Ç –ø–æ –∫–ª—ñ—î–Ω—Ç–∞—Ö',
      'categories': '–ó–≤—ñ—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è—Ö',
      'products': '–ó–≤—ñ—Ç –ø–æ —Ç–æ–≤–∞—Ä–∞—Ö',
      'store-products': '–ó–≤—ñ—Ç –ø–æ —Ç–æ–≤–∞—Ä–∞—Ö —É –º–∞–≥–∞–∑–∏–Ω—ñ',
      'receipts': '–ó–≤—ñ—Ç –ø–æ —á–µ–∫–∞—Ö',
    };

    if (!endpoints[type]) {
      alert('–ù–µ–≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –∑–≤—ñ—Ç—É');
      return;
    }

    fetch(endpoints[type])
      .then(res => {
        if (!res.ok) throw new Error(`–ü–æ–º–∏–ª–∫–∞ ${res.status}`);
        return res.json();
      })
      .then(data => {
        document.getElementById('report-title').innerText = titles[type];
        document.getElementById('report-output').innerHTML = generateTable(data, type);
      })
      .catch(err => {
        console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–≤—ñ—Ç—É:', err);
        document.getElementById('report-output').innerHTML = '<p style="color:red;">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–≤—ñ—Ç.</p>';
      });
  }

  function generateTable(data, reportType) {
    if (!Array.isArray(data) || data.length === 0) {
      return '<p>–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è.</p>';
    }

    // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –Ω–∞–∑–≤ –∫–æ–ª–æ–Ω–æ–∫ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞
    const columnNames = {
      // Employees
      'id_employee': 'Employee ID',
      'empl_surname': 'Last Name',
      'empl_name': 'First Name',
      'empl_patronymic': 'Middle Name',
      'empl_role': 'Role',
      'salary': 'Salary',
      'date_of_birth': 'Date of Birth',
      'date_of_start': 'Start Date',
      'phone_number': 'Phone Number',
      'city': 'City',
      'street': 'Street',
      'zip_code': 'ZIP Code',

      // Customers
      'card_number': 'Card Number',
      'cust_surname': 'Last Name',
      'cust_name': 'First Name',
      'cust_patronymic': 'Middle Name',
      'percent': 'Discount (%)',

      // Categories
      'category_number': 'Category ID',
      'category_name': 'Category Name',

      // Products
      'id_product': 'Product ID',
      'product_name': 'Product Name',
      'characteristics': 'Characteristics',
      'producer': 'Producer',

      // Store Products
      'UPC': 'UPC',
      'UPC_prom': 'Promotional UPC',
      'selling_price': 'Selling Price',
      'products_number': 'Quantity in Store',
      'promotional_product': 'Promotional',

      'check_number': 'Number of check',
      'print_date': 'Date',
      'sum_total': 'Sum',
      'vat': 'VAT'
    };

    // –ó—ñ—Å—Ç–∞–≤–ª–µ–Ω–Ω—è —á–∏—Å–ª–æ–≤–∏—Ö –∫–ª—é—á—ñ–≤ –¥–ª—è –∑–≤—ñ—Ç—É receipts
    const receiptKeyMapping = {
      '1': 'check_number',
      '2': 'print_date',
      '3': 'sum_total',
      '4': 'vat'
    };

    // –í–∏—Ç—è–≥—É—î–º–æ –≤—Å—ñ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ –∫–ª—é—á—ñ –∑ —É—Å—ñ—Ö —Ä—è–¥–∫—ñ–≤
    const keysSet = new Set();
    data.forEach(row => Object.keys(row).forEach(key => keysSet.add(key)));

    // –î–ª—è receipts –∑–∞–º—ñ–Ω—è—î–º–æ —á–∏—Å–ª–æ–≤—ñ –∫–ª—é—á—ñ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ
    let finalKeys;
    if (reportType === 'receipts') {
      const mappedKeys = [...keysSet].map(key => receiptKeyMapping[key] || key);
      const idKeys = ['check_number'];
      const otherKeys = mappedKeys.filter(k => !idKeys.includes(k)).sort();
      finalKeys = idKeys.filter(k => mappedKeys.includes(k)).concat(otherKeys);
    } else {
      const idKeys = ['id_employee', 'card_number', 'category_number', 'id_product', 'UPC', 'check_number'];
      const otherKeys = [...keysSet].filter(k => !idKeys.includes(k)).sort();
      finalKeys = idKeys.filter(k => keysSet.has(k)).concat(otherKeys);
    }

    let html = '<table><thead><tr>';
    finalKeys.forEach(key => {
      html += `<th>${columnNames[key] || key}</th>`;
    });
    html += '</tr></thead><tbody>';

    data.forEach(row => {
      html += '<tr>';
      finalKeys.forEach(key => {
        // –î–ª—è receipts –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –∫–ª—é—á —ñ–∑ –¥–∞–Ω–∏—Ö
        const dataKey = reportType === 'receipts' ? Object.keys(receiptKeyMapping).find(k => receiptKeyMapping[k] === key) || key : key;
        html += `<td>${row[dataKey] !== null ? row[dataKey] : ''}</td>`;
      });
      html += '</tr>';
    });

    html += '</tbody></table>';
    return html;
  }

  function printReport() {
    window.print();
  }
</script>

</body>
</html>